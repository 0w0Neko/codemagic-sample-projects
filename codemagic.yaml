workflows:
    ios-staging-workflow:
      name: iOS Staging Workflow
      working_directory: ios/ios-automatic-code-signing-demo-project
      environment:
        vars:
          XCODE_WORKSPACE: "swiftly.xcworkspace"
          XCODE_SCHEME: "swiftly"
          BUNDLE_ID: "io.codemagic.cmswiftly"
          # https://docs.codemagic.io/code-signing-yaml/signing-ios/
          APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmd1S0p2TGp6elRIY2thcURYb24zdFE1YzBDSk54OUhmbmMyT3F2aGJoUXU3Z3BZdjJycnJrTFpfaE16VU4tbzFURTBzeXdYc1dfYUR0UEdIZExYeTQwNGlBQUxsVWdYbVdNWlVPOURIaTRRdFdWLXB4QWJGbm9XWS1vX2JwbHhQNTFqU0o=)
          APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmd1S0tIamJ3UjZMbUJkMXB5eXZfTXItSkdnZVNQNFFjQkdLUFV1THlaYUd5cTBNVkFfdEZSM2p5bHJkZGl5bWZkUVJ5alpFV2s0aERnX2ZxYXVpOTlSbE90SUE9PQ==) 
          APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmd1S0tzUFRMV0JEX09MakRJaHk5TVc4NUkwTWNFbmhTWVJGMFlodUZabkFWRG96LTljc3BURTFhQXdEc3U2NDdHNTZaTUFFZk5vZHVnM1ZCTWN2NnhHSFppdHhPeU5TbjRPenZiSGlHQUdsNW1mMXJ5d2V3Yk5ZeWxaeVRrYUY3N2I2cjNYQ19iSFhqOGZCY1JFM0xteER4eUUxS1BNeVJIaDFUN2FabHJfeHFXMExjV2RzanVkT0s2SVh2aTV3TnZWaU01ZFhKZUExT3BsOFpaUWR6Tkh4SkVWaDZyaGp0QjZ0SGo2OEdqTVhrdUJhdnpBVWlTQm1GdUY4NTBxcERKVlJrM1JwMDRGeXRNOHNVMWd0ZHFXVF95SklVVUk4TDBUUWQ3RjktMndqd3NMU0FDQzV4TEM3SmdJYnpISXdqS05Mbl95ekNFcjY5UU04T2g5bEo0T081cGhvYmFVR2diMkMzQmppZUI0UGVycGU4Uk9hX2NURXg0QkhaRWdRT0xzekJTaXJQdGk4b0JSdjdKQm5kY1l3YnRrTTNXdXZnOGpGeW50RkpiQ3RGSGNORT0=)
          CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmd1S05zUWtJRDdzNFVwSVNZSXFtRUVXUkFicjZQU0lHYTRUaXBpalFab1cwZEdyN1NOa0w2cVJkR0lNYlRPaGd4YV9GZjhDTnZ4d1FCUDdUYTZ3Ty01NHZ3QUFRQ2FjTU5iZFczdVVwemFnVXYzVUhlYjV2MTUySXcwSE5jZlQ3Y1V0SUwwTjI2ZUtHX29uVlhCT0xEM2x1ajNJR3RYeE16eW1FU1VEQy1jblg1MDdBek04RVhfOWZWTUdRUzQ0SmpPeUdWYTlfRThHMW5BNU1KNXNWZjBQeDZvYW5lY2lYdlFYMldwcE5oNUdtbXM0eEo0Z0lrWUk4XzRKUGVGWjJpYXBHZGR5YlE2N3R3QjBHR2QzOU9BcHB6Y3RVT1IzNTdiUE1veF9MY3JRTkVtMFBHa2xSa2xmTmJKZkZJa2dvckg4YmZGS1pWRjU2Q051V2g3a0lURmh5eWJRQUoyN2gyT2lpR1VqSGNTUHBaSzBzeFoxanZwM0NyYU1VbHY2ZW9uRi14dXhSX3MyRVBIcTZmWlV1MU1ZM0JwVzVWSjAxOXdPU0hrWFcyTlRmN2o4NkZIQWdZbFZ0RS1qdWJyWlkzSkFlazdMN2dFd1lPanU0SUFuM2E4ZUpsM2xVMkw0aHMzd1hqT2dhUXRqV0hheFVXWU5Hcmp6eVBXcDRtb2tQaHcyWC1VX2l5YmR0OW5ib1FacnFDSXBiaVFKY3BOazVLeDNBUEota3Mxb1BBMVhVZ1Foc1N3aHhrRFdpRG8zYkpPUDJGVnk5Tmx1ZUZNdzVjeVZiZ0pzRzVlR3VBaUdWVk9kSXRjbE0zQ2xPVks3aHBhby1vM0hhN3AzUjhBa25IeHdTWkZvV1I5WHJtUEp3NzlsSjhsSE03VFpMNzZYN3JqMU15RUN0S0VCZ015SlJ6VHBEbFlRSDVmaGZQOS1pN0loTmVIVHRvdzlkLXBDMzZzWXFUUGFjdnF5YkhhTFUzSFAzQ2gxVGxfMHFpNzZxaUNwaGxBUjI2MEJrRTNaQVlNQVVlZGZidTJ3Q0FON0VvaHVrMlI5M0ctdXp5WjU0Nm5kMDBmS3lRUlU1SmgwQXJUSWl2REdidy1SZVg5QVNXb2xScWsxNnUzWlZZVkY2eTNLOXN3b0hrd0ZsdjVzSHphNWlydzZLRWJaMUhNV0x5dEZHcDY1MElGM3JsT2RQRHJPN2JYNlRqSFRCVGl1c24yQUxVM00yanJuUU5HM3FFc2hjNWJHMDROQXo0VW16WXROdEFjOXVnU2Jab1ZkQmhYdFNvQUVUSUJIc2hZUFRQLVBjX2xtTjl4RkFDeTVjcS13WkI4RFhwMmEyVk5rbjVhY1VaelJWOEduWVVNdnVROTFmMVlUU3VjUXpWS3hfVjktVDI0LVh1X014WnRQSXlSZm5MSnBZb0x6SVV0UTRZZTk2OU9GVkR1dlhvcnlGNDN2dmJ0OTdlazM5YXl3NDJoM05UVHU4ckpzR3VXek15NWVMNVFtT3pFLXBKMExaWHFBLUt5ek5rTEJxUXRBaXBmdEhieXdjbThqREZPUDB6MTBmNlFhb3lUZjQwaXI4WFRsYXJvR3M0Sm9TcWIzbFVBZFhmRnZIa3BJbVdZUUt1UG1leTdQa3p0UjRkX3hSdTZlRU5tZUFJanR1cTFzd09Yb3NpSUZsVUJKV2FmRVJYSW1CVWtqZXpzY3RWclk5WWs2WUlMcWU0Qi1VaHpNZEZINHNlLUtmZE5tU09HcjNtU3M3cm9DMVZwS1Z6TXIzUDJmUFBTNkktQUNzRC0za1dUcHYyYm95c3F5SFY2Ymw2LUMyVkUzNEhKTTdwNnhhSGJZYXE2MExxWG1idkJISXk5LTdoV2R6NllTU2FMQjYtY0V3bFlVSHpnRkVaN0tPU1d5bWFDcU83UUh1T1hpcldmSVZNZDBaRGh6UXFzd3BTdmx5MHFjblhVYUFfYlBubDlJYUxudTNHNGJoNXJrTjdWZUdtcE9UYmRYSXpTNkJ6OHFNRWY3MDRwZWFXd3JSZ09JOElDTXoweFRzMkwzOC11Y1FyN1g3RlNLaDVYVm42ZU1FVkQ1cjRGNTh6UzcySHJwRFFiSjJvS2RCYjVqNGJDT2dudFZlZVBmbnJTYm5XYnlRUkZkNWZtYmZ2N1Q5Z2NWZmh0ejRhaWFWckRfUHBNNkt3Y08zeTJvOUxIaVEzaEVsSmQ5dWVWNG9wVFZjTC0wdXdzemMyOFEzYmVmOURUakRSbWZVR05pdE15elJrWGltRndCaTFISlhQcGhXZmpDRGZLUWp1NUZtWF9aT1JmNHYwZjhJZ0VINGlSMnd1NnhvNzYxWDBVdm92Z28zVzJzNWctaHJxYzdIWURWek5QcFlvTk1HRkNXc1NiTmZmWjlKbS1qb2gybWxzWnFON3kwTV9ycVl6LTR4WGRmZW5CbzE3Q1BJOGR4THRJN083VjQ0THIwZlp1OG9QV1lsdk43LUNzRVh1akVMYzJVeTdqdW9JNDVUaHkwajY2TUdpSFhFbzNIenJ4bXJuY0RuWGw4bkFRQzdsdGFEcWxrRmpubG5zOUtxWWsySGFvamJ5anBkXzA4aEg0dU9TeVhUSXNBb3NyQU9QVm1lakU3Q2Mtc1cxeng4c0J4RzlHamo5U3h1ZzdZSW1SUW5JeDdDTjRlVkdBcGNDMF9KUXNKRU0ySS1ucWg4QWM3WFlOamRvVWZMekN6cDRpU29GczVrSEFMNXFNUnMxazJzdTY1Ti04VDh3LXF2bXlndXZiWVhsTkxtYXZENTA2azZJWE9SZ0gyZE81a2VsZGM3RC02ZkwyZFdhNjhPeFpIYTBLVkV5VGdUSGRYanRxS01FcmlWWWQ4MWpRaW9wZXVyNDg2dDhjbEZxMmUxNUNjR0RjWHp4TDVIQUxMVkU2VUpMMllOZjZWVHNlNkRUSDBKclpPSElkVjQxMmpwbkkwUUdQZGR2bF9CTk55dVZ5anJNSl9RdV9JbWxnRmtrRWpYc0lhajBIT2MwUUo3M01ZQnZFbVlIV2N0VFJnUWZQZlVjZjVWRmVPQm5hSVlqbS1GSmxQc3g4b0tv) 
          APPLE_ID_EMAIL: Encrypted(Z0FBQUFBQmd1S0xRNDBqLVQ1UkJac29IeEVxWjZQRmNRbTQ5U1pFb2cyRlEwUHBSMGtnLWZqc3ktRE5VeHJYRnF0TmJDSjh5MDNGM3dGZnI5ZHQ3MzY3bWN2TGJ3RGVnY0pSUnJpRWY4VkZSRWMzaEl1T25nZzQ9)
          APP_SPECIFIC_PASSWORD: Encrypted(Z0FBQUFBQmd1S01mbTZWTnRqbTc0U2tDeGh1TTZkZjQybHNFeUthT3FvaUx1ZXY4eWVkbkxxV1NuaVJrU2lKT3VMY0VWLThBbnVkVEVwZ0xyVThaU0JJMUxORmxyUXVOcnA3Tm1BQzhUeEpxbVVnS1NpWS01TGM9)
          APPLE_APP_ID: 1570610860
        xcode: 12.5
        cocoapods: default
      triggering:
        events:
          - push
          - tag
          - pull_request
        branch_patterns:
          - pattern: 'develop'
            include: true
            source: true
      scripts:
        - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
          script: |
            keychain initialize
        - name: Fetch signing files
          script: |
            app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create
        - name: Use system default keychain
          script: |
            keychain add-certificates
        - name: Set up code signing settings on Xcode project
          script: |
            xcode-project use-profiles
        - name: Increment build number
          script: |
            #!/bin/sh
            set -e
            set -x
            cd $FCI_BUILD_DIR
            agvtool new-version -all $(($BUILD_NUMBER + 1))
        - name: Build ipa for distribution
          script: |
            xcode-project build-ipa --workspace "$XCODE_WORKSPACE" --scheme "$XCODE_SCHEME"
      artifacts:
        - build/ios/ipa/*.ipa
        - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
      publishing:
        app_store_connect:   # https://docs.codemagic.io/publishing-yaml/distribution              
          apple_id: $APPLE_ID_EMAIL   
          password: $APP_SPECIFIC_PASSWORD
        email:
            recipients:
              - user1@example.com
            notify:
              success: true
              failure: true
        slack:
            channel: '#builds'
            notify_on_build_start: true    # To receive a notification when a build starts
            notify:
              success: false               # To not receive a notification when a build succeeds
              failure: false               # To not receive a notification when a build fails