workflows:
    ios-swiftly:
      name: ios_swiftly
      instance_type: mac_mini
      environment:
        vars:
          XCODE_PROJECT: "swiftly.xcodeproj"
          XCODE_SCHEME: "swiftly"
          BUNDLE_ID: "io.codemagic.swiftly"
          APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmd1S0p2TGp6elRIY2thcURYb24zdFE1YzBDSk54OUhmbmMyT3F2aGJoUXU3Z3BZdjJycnJrTFpfaE16VU4tbzFURTBzeXdYc1dfYUR0UEdIZExYeTQwNGlBQUxsVWdYbVdNWlVPOURIaTRRdFdWLXB4QWJGbm9XWS1vX2JwbHhQNTFqU0o=)
          APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmd1S0tIamJ3UjZMbUJkMXB5eXZfTXItSkdnZVNQNFFjQkdLUFV1THlaYUd5cTBNVkFfdEZSM2p5bHJkZGl5bWZkUVJ5alpFV2s0aERnX2ZxYXVpOTlSbE90SUE9PQ==) 
          APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmd1S0tzUFRMV0JEX09MakRJaHk5TVc4NUkwTWNFbmhTWVJGMFlodUZabkFWRG96LTljc3BURTFhQXdEc3U2NDdHNTZaTUFFZk5vZHVnM1ZCTWN2NnhHSFppdHhPeU5TbjRPenZiSGlHQUdsNW1mMXJ5d2V3Yk5ZeWxaeVRrYUY3N2I2cjNYQ19iSFhqOGZCY1JFM0xteER4eUUxS1BNeVJIaDFUN2FabHJfeHFXMExjV2RzanVkT0s2SVh2aTV3TnZWaU01ZFhKZUExT3BsOFpaUWR6Tkh4SkVWaDZyaGp0QjZ0SGo2OEdqTVhrdUJhdnpBVWlTQm1GdUY4NTBxcERKVlJrM1JwMDRGeXRNOHNVMWd0ZHFXVF95SklVVUk4TDBUUWQ3RjktMndqd3NMU0FDQzV4TEM3SmdJYnpISXdqS05Mbl95ekNFcjY5UU04T2g5bEo0T081cGhvYmFVR2diMkMzQmppZUI0UGVycGU4Uk9hX2NURXg0QkhaRWdRT0xzekJTaXJQdGk4b0JSdjdKQm5kY1l3YnRrTTNXdXZnOGpGeW50RkpiQ3RGSGNORT0=)
          CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmd1TUpCQWM0aEtWTHYwSFdHb0lyTFhlajcxZkV5VkhQWWpkVjFnNG1NVGI4YVFfWEdyd1F6YW1LWjIzeENkVWxjNlhRSnQ5OWNqNmdqNm84d3FmdlhFQUNRNmp4Ym1Sckp1enBfUEpKdmJMOURETFFwdFNoVkhuWl9tdGJBNFFyTGw5RXpQMUVjWjBvNFlHUnVSajl6a2RLNWNUN2tUcnlwcUFtUzEzbXpubnJaQVdHODdGWnpTTDVCRlVTTm9feUIybkpyVm14YzRzV29BSV9PNHRoTW1UUUFmbkNtTURIWEVxeHFCTlNDZU5UNzNaaHlJMk8xWFJ4Nlc3cXNwcU1OZmVVdW5SYWpHVVotNkNYVVFYQVZSZ1B1cE9fd05BNzl3TlphZ3VaQjFocy1TTjBXWXQ4NXJubFd0dmFEMnVlODJYYUJrY3RibllNODJsai1BcENlRFM4TmVtNGczM1ZoM1p1UkRNQ1dLZ29IaC1pdlhQN1R0RnlYc2hvT2ZvSzNLakkwYkJKVjJBX0E4R0F6ZGpmQjhMM081U01TU3ZFc0hKZXBRZThzUWRLYks3REowT2JRd1BYeWJCenRaYU5jZU5GNXBXREpRcVBhc3l2V2JOUUw0VWhJb0xCcGM1b3VMdUJzdUhCVnVxNzhFWkFDbE9EREE2YlV5SWdpM1JWYzBmZFUweXFrLWc2Z2ZOenJLLXc0V1hkekZyOVJPSFBPek5nNUdvYjlROWtiNmZ4V1dLQWF5VHdxM0oxS3JZN083YTNfUDFmWmlFcjRreDJjNFBKelEwcTBYVGJraUJWaVRXZ1lJUm8wZWFmN2RMMzNzQTQ3STU2SkM3MVlkRVNQNXZrUmhMN2c2QnEtSzlFVUxISVBCU05Jc1FFNXhGVHp0cmNjTUhDS0FYX3F0S1B5V0pmZGRGRVFEa09ZMGtWY0hHLXBobXl2UDRrYTAzbEhDRkxBN2xpQUs4eWpWekdfQmZwQ2JDbmgzS0JGY0ZlVkgySWIwUHh2c0JzRnFPYm95c256aTBVRmZuYTZaZ19xSDIyX1dmRGZUTmhjTjlGd1BSWlJHbGZsRDNsM00xUkJRTkhUY0xrOG1sQl9Za1AtdjJpMWMxTEJzUTV0eGdwekxtM1hTNXZFY1NPWDR2RWtSWEFwem80S20zYmZqMnFPQnA4akd4aEtvdk1ZOVBBNTFIWVlYS2t1V3ZESFdvNlNHSUdIUG4zU2lXOEJVNEpNUG9kbHFpVDdMR2FtMTZMSE1KNU9sY0gxLVR2c0JuNFNmdnVxMGNTQnFTbGduaF83Y01pNjdKQ3ZVNERCVDBmb3RURGNIOWlPLWhCbDdoaDExTGRDNlJ3Uk5jaXBKQlBiU2hvZnhfRmZQWUJrcGJ5NnJWZ0ZRTEhYNWVVdlhHOHdMVXZHektLbmNRbWt6T21xUEtEN19KTmpSajFfVS1nUEtlQjBWX0d5NjR0dTJERC1pZ3dSOTlBd01NTmthMmtZc1BHa0pqWG14anRlc1R3NGo5d1I1bnpvdm5GbDdLd2E2TVlhWTVycU1Sd1VJdDFXZUl6Y2czaGFtWmI0ZDVBTUlDM3BKMFlsbmxjVVYycC10YVVHcmV0d00tUmdVTUhLWFB6enEzTDMxUGhtLXFUZ3RmOU5qTk5NV254Mkc3WFJnd3FCakc0bndXR0o3LXBNa0Y0cml0cThBdG4zaV9DdmxiOFgtMzk4Zm15Qi1UNmNHVEZJUVFfOFB6Sk1HTkcwQ05UWVRxcWdRXzh5X21qZ1JBbW43QklVU2JwLUVIa1FOZEF3eHVXaDJRaFhDck5hV25iLTZwdDVuZUhwOGNuUzFnRDJ5OEIyNGlaY1ltQnNIWlBQdXVSMDF1empBYTk2RVdlSVJoU2VYQnFyMGVZbnNmUVZhLXhfQnBwTjVfdm5Wc2xodEdrdWEyXzFCZW5PLWNtSjA2ZU9JZjdJQWxBRmhDcUZpQ0JnZTJxWE1lUHpIRVNLU005S0pZVjZKZERqTmdieHVNQkFmQmhrTlJYVmxERnFPal8waDNRYVZUMkZUTGlDZDVGRDlfUTQ1WXFTOGZOdG5vSUx0YVJtbTRSVjZ6bEJDMVZ3TGlNLTVUNFVGenVUQXBRQlBLbVlsN2lFX3BJMHFDbG1kUUFycUlobGdkbzZVdGVmSl9lRjZfOHZXSEF0dWQ1RERzQTNNbW9xdUZmeXFXMklvdEV1SHhPa1VhX0lsM3NXS3p2WHZFOGdWbXNJZXo5UDc4X1VaWlVwbWN6b3o1R243UTJra1ZMc1RtYXk1SWdVUjFuc1U2aW9nSEl2ZEl1TVdEUnNFWUFXSG14WW50a2hfZk5rSWpsdHdQLXNsUGthZmJtcUNvVk0xeEE4bVZTNDRiME9EM0htUmI5Tzh2Umk5bzlqY2Q4cGl5TmVUMXZEQThhUFBpb3M3ZU92N290bUdHSmNya2VhaFBMZXdYSjcyLWdybmRtOFh2ZVFjeUp0WGpkRlJjX3JfQ05yeWFQYm9SX0ZEWUlzUl9SYmpQcGxyV2N6QXlMMW1sUGNOMURYbjA5bDkwazJCZVdPa3diU0tGS3d5VmtGUE1ZMnJyNEtVS2IxUFU0bG1nRS1ZbWVXTzg0ZUVtemctZVNkU0l4YXcydHU2dlhnZVJYNUtrVDFicjBmRE9RZmZsT21vanNLdWFkMlN3VG9PYXBFYkg2VUNTcGxNQkJ4ZzRlOFUyWk5ZMFNzQVg3ejVlVUtDdkpTak1ldTB1LVJjcy12bUhrSU9hVHNLcFRfVXJscV9PSjFjbmZJZ0RDaW9KY0ZyNnZobGt2UThPMkdaZkhiOHBPTTE3WG4xVExRTThwbk1fenJ6RXlwNUtHV3A4UEhRRF8yRkFZd0ZEQjdrNkVsbFh0cy1sVHlyejZ2YjRvTFpjZ0I3UmRVRXdTMmY1N3ROTFpTWnVZZVhBRjBBQUFMR1BjSUgwMUREVElNem1tOGJBcmZ6OWhFR19IOENRcTBWZHh1NTk0RC1oNkJva1dOekhlakhlanhYeVEwbWtDRHVnYkxMZWZiQkxkaDNXOEhFMlR0YVBPX2pab1FnbWZr)
          
          APP_STORE_APP_ID: Encrypted(Z0FBQUFBQmhFWGlaWms5b1FESzU1TE1Ia2E0ektIM3J2Y1pPalQ3U1E0OHl6cFJNU3R3Zkx0THBtenlMal9kbXNMdUljODlZV0hzbE5qYkNYcHByQk9tLVhwaDF1TGppd0E9PQ==)
        xcode: 12.5
        cocoapods: default
      triggering:
        events:
          - push
          - tag
          - pull_request
        branch_patterns:
          - pattern: develop
            include: true
            source: true
      scripts:
        - name: Codemagic CLI Tools build
          script: |
            #!/bin/sh
            set -ex
            pip3 install codemagic-cli-tools # The Codemagic CLI tools are already installed on Codemagic servers
            keychain initialize
            app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create
            keychain add-certificates
            xcode-project use-profiles
            agvtool new-version -all $(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_APP_ID") + 1))
            xcode-project build-ipa --workspace "$XCODE_WORKSPACE" --scheme "$XCODE_SCHEME"
            
            # Use Codemagic to publish to take advantage of asynchronous Magic Actions otherwise use app-store-connect publish command and pass whats_new.json for release notes.
            # app-store-connect publish --beta-build-localizations=@file:whats_new.json 
      artifacts:
        - build/ios/ipa/*.ipa
        - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
        - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      publishing:
         app_store_connect:
           api_key: $APP_STORE_CONNECT_PRIVATE_KEY          # Contents of the API key, can also reference environment variable such as $APP_STORE_CONNECT_PRIVATE_KEY
           key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER        # Alphanumeric value that identifies the API key, can also reference environment variable such as $APP_STORE_CONNECT_KEY_IDENTIFIER
           issuer_id: $APP_STORE_CONNECT_ISSUER_ID          # Alphanumeric value that identifies who created the API key, can also reference environment variable such as $APP_STORE_CONNECT_ISSUER_ID
           submit_to_testflight: false                      # Boolean use to indicate if you want to submit to TestFlight review so external testers can test your app             
         email:
           recipients:
            - kevin@nevercode.io
